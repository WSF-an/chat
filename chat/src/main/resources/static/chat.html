<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>èŠå¤©</title>
    <link rel="stylesheet" href="chat.css">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://unpkg.com/vuex@3.6.2/dist/vuex.js"></script>
    <style>
        /* ä½ åŸæœ¬å¯ä»¥ç”¨ chat.css ç®¡æ ·å¼ï¼Œè¿™é‡Œåªæ˜¯ç¤ºä¾‹ */
        .active-chat { background-color: #d0e6ff; }
    </style>
</head>
<body>

<div class="left_layout" id="left_layout_id">
    <div class="father_icon">
        <div id="sonIcon" class="son_icon" onclick="btn_icon()"></div>
    </div>

    <div class="new_chat_top">
        <button class="new_chat1" onclick="createNewChat()">æ–°å»ºèŠå¤©</button>
        <button class="new_chat1" id="sendDataBtn" style="margin-top: 10px;">å‘é€æ•°æ®</button>
        <button class="new_chat1" id="downloadDataBtn" style="margin-top: 10px;">ä¸‹è½½æ•°æ®</button>
        <input type="file" id="jsonFileInput" accept=".json" style="display: none;">
    </div>

    <div class="chat_list_container" id="chat_list_container">
        <div class="new_chat new_chat_text active-chat" data-convid="ä¼šè¯1" onclick="switchChat(this)">
            <div class="no-select" style="flex:8;color:#262626;">ä¼šè¯1</div>
        </div>
    </div>

    <div class="left_person">
        <div style="display:flex;justify-content: center;align-items:center">
            <div class="false_img">
                <div class="my_img_son1"></div>
            </div>
            <div class="false_img_right">
                <strong id="username_display">æ¸¸å®¢</strong> <!-- é»˜è®¤æ˜¾ç¤ºæ¸¸å®¢ -->
            </div>
        </div>
    </div>
</div>

<div class="right_layout">
    <div class="right_layout_son">
        <div id="chat_history" style="height:300px; overflow-y:auto;"></div>
        <div class="right_layout_son_ipt">
            <textarea class="ipt" id="messageInput" placeholder="æ¥è¯´ç‚¹ä»€ä¹ˆå§..." rows="3"></textarea>
            <button class="btn" onclick="sendMessage()">å‘é€</button>
        </div>
    </div>
</div>

<!-- ğŸš€ è„šæœ¬ç§»åˆ°åº•éƒ¨ï¼ -->
<script>
    const userInfoStr = sessionStorage.getItem('userInfo');
    if (userInfoStr && userInfoStr !== 'undefined') {
        try {
            const userInfo = JSON.parse(userInfoStr);
            console.log('å–åˆ°çš„ userInfo æ˜¯:', userInfo);
            document.getElementById("username_display").textContent = userInfo.uname;
        } catch (e) {
            console.error('userInfoè§£æå‡ºé”™:', e);
            document.getElementById("username_display").textContent = "æ¸¸å®¢";
        }
    } else {
        document.getElementById("username_display").textContent = "æ¸¸å®¢";
    }

        window.addEventListener('DOMContentLoaded', () => {
        loadChatList(); // ğŸ‘ˆ é¡µé¢åŠ è½½æ—¶è·å–ä¼šè¯åˆ—è¡¨
    });

        function loadChatList() {
        axios.get('/api/chat/get_list')
            .then(response => {
                const chatLists = response.data;
                const container = document.getElementById('chat_list_container');
                container.innerHTML = ''; // æ¸…ç©ºå·²æœ‰

                if (!Array.isArray(chatLists) || chatLists.length === 0) {
                    container.innerHTML = '<div style="padding: 10px; color: gray;">æš‚æ— ä¼šè¯</div>';
                    return;
                }

                chatLists.forEach((chat, index) => {
                    const chatDiv = document.createElement('div');
                    chatDiv.className = 'new_chat new_chat_text';
                    chatDiv.dataset.convid = `ä¼šè¯${chat.conversationId}`;
                    chatDiv.onclick = function () {
                        switchChat(this);
                    };

                    const title = document.createElement('div');
                    title.className = 'no-select';
                    title.style.flex = '8';
                    title.style.color = '#262626';
                    title.textContent = chat.description || `ä¼šè¯${chat.conversationId}`;

                    chatDiv.appendChild(title);
                    container.appendChild(chatDiv);
                });

                // å¯é€‰ï¼šé»˜è®¤é«˜äº®ç¬¬ä¸€ä¸ªå¹¶åŠ è½½å…¶èŠå¤©è®°å½•
                const firstChat = container.querySelector('.new_chat');
                if (firstChat) {
                    firstChat.classList.add('active-chat');
                    switchChat(firstChat);
                }
            })
            .catch(error => {
                console.error('è·å–ä¼šè¯åˆ—è¡¨å¤±è´¥:', error);
                alert('æ— æ³•åŠ è½½ä¼šè¯åˆ—è¡¨ï¼Œè¯·ç¨åé‡è¯•');
            });
    }


    function sendMessage() {
        const input = document.getElementById('messageInput');
        const message = input.value.trim();
        if (!message) return; // é˜²æ­¢ç©ºå†…å®¹

        // è·å–å½“å‰çš„ä¼šè¯IDï¼ˆå‡è®¾ä½ å·²ç»æœ‰æŸç§æ–¹å¼æ¥è¿½è¸ªå½“å‰ä¼šè¯ï¼‰
        const conversationId = document.querySelector('.active-chat').dataset.convid.replace('ä¼šè¯', '');

        axios.post(`/api/chat/${conversationId}/message`, {
            message: message
        })
            .then(response => {
                const reply = response.data; // åç«¯è¿”å›çš„AIå›å¤

                // æ›´æ–°èŠå¤©è®°å½•
                const chatHistory = document.getElementById("chat_history");

                // åˆ›å»ºå¹¶æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
                const userMessageDiv = document.createElement('div');
                userMessageDiv.style.display = 'flex';
                userMessageDiv.style.justifyContent = 'flex-end'; // ç”¨æˆ·æ¶ˆæ¯æ˜¾ç¤ºåœ¨å³ä¾§
                const userMessage = document.createElement('div');
                userMessage.textContent = message;
                userMessage.style.backgroundColor = '#e0f7fa'; // è®¾ç½®èƒŒæ™¯è‰²
                userMessage.style.padding = '8px';
                userMessage.style.borderRadius = '8px';
                userMessage.style.maxWidth = '70%'; // é™åˆ¶æœ€å¤§å®½åº¦
                userMessageDiv.appendChild(userMessage);
                chatHistory.appendChild(userMessageDiv);

                // åˆ›å»ºå¹¶æ˜¾ç¤ºAIå›å¤
                const aiReplyDiv = document.createElement('div');
                aiReplyDiv.style.display = 'flex';
                aiReplyDiv.style.justifyContent = 'flex-start'; // AIå›å¤æ˜¾ç¤ºåœ¨å·¦ä¾§
                const aiReply = document.createElement('div');
                aiReply.textContent = reply;
                aiReply.style.backgroundColor = '#f1f1f1'; // è®¾ç½®èƒŒæ™¯è‰²
                aiReply.style.padding = '8px';
                aiReply.style.borderRadius = '8px';
                aiReply.style.maxWidth = '70%'; // é™åˆ¶æœ€å¤§å®½åº¦
                aiReplyDiv.appendChild(aiReply);
                chatHistory.appendChild(aiReplyDiv);

                // æ¸…ç©ºè¾“å…¥æ¡†
                input.value = '';

                // æ»šåŠ¨åˆ°æœ€åº•éƒ¨
                chatHistory.scrollTop = chatHistory.scrollHeight;
            })
            .catch(error => {
                console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
                alert('æ— æ³•å‘é€æ¶ˆæ¯ï¼Œè¯·ç¨åé‡è¯•');
            });
    }

    function switchChat(clickedElement) {
        const conversationIdStr = clickedElement.dataset.convid;
        console.log(`åˆ‡æ¢åˆ°ä¼šè¯: ${conversationIdStr}`);

        // æ¸…é™¤æ‰€æœ‰é«˜äº®
        document.querySelectorAll('.new_chat').forEach(chat => {
            chat.classList.remove('active-chat');
        });
        clickedElement.classList.add('active-chat');

        // è·å–ä¼šè¯ç¼–å·
        const conversationId = parseInt(conversationIdStr.replace('ä¼šè¯', ''));

        // è·å–èŠå¤©è®°å½•
        axios.get(`/api/chat/${conversationId}/history`)
            .then(response => {
                const history = response.data;
                const chatHistoryDiv = document.getElementById('chat_history');
                chatHistoryDiv.innerHTML = ''; // æ¸…ç©ºæ—§æ¶ˆæ¯

                history.forEach((msg, index) => {
                    // åˆ›å»ºæ¶ˆæ¯å®¹å™¨
                    const msgDiv = document.createElement('div');
                    msgDiv.style.marginBottom = '8px';
                    msgDiv.style.padding = '6px';
                    msgDiv.style.borderRadius = '8px';
                    msgDiv.style.backgroundColor = '#f0f0f0';
                    msgDiv.style.display = 'flex';
                    msgDiv.style.flexDirection = 'column'; // è®¾ç½®ä¸ºç«–ç›´å¸ƒå±€

                    // åˆ›å»ºæ¶ˆæ¯å†…å®¹å®¹å™¨
                    const userMessageDiv = document.createElement('div');
                    userMessageDiv.style.display = 'flex';
                    userMessageDiv.style.justifyContent = 'flex-end'; // è®©æé—®æ˜¾ç¤ºåœ¨å³ä¾§
                    const userMessage = document.createElement('div');
                    userMessage.textContent = msg.message;
                    userMessage.style.backgroundColor = '#e0f7fa'; // è®¾ç½®èƒŒæ™¯è‰²
                    userMessage.style.padding = '8px';
                    userMessage.style.borderRadius = '8px';
                    userMessage.style.maxWidth = '70%'; // é™åˆ¶æœ€å¤§å®½åº¦
                    userMessageDiv.appendChild(userMessage);

                    const aiReplyDiv = document.createElement('div');
                    aiReplyDiv.style.display = 'flex';
                    aiReplyDiv.style.justifyContent = 'flex-start'; // è®©å›ç­”æ˜¾ç¤ºåœ¨å·¦ä¾§
                    const aiReply = document.createElement('div');
                    aiReply.textContent = msg.reply;
                    aiReply.style.backgroundColor = '#f1f1f1'; // è®¾ç½®å›ç­”èƒŒæ™¯è‰²
                    aiReply.style.padding = '8px';
                    aiReply.style.borderRadius = '8px';
                    aiReply.style.maxWidth = '70%'; // é™åˆ¶æœ€å¤§å®½åº¦
                    aiReplyDiv.appendChild(aiReply);

                    // å°†æé—®å’Œå›ç­”éƒ½æ·»åŠ åˆ°æ¶ˆæ¯å®¹å™¨
                    msgDiv.appendChild(userMessageDiv);
                    msgDiv.appendChild(aiReplyDiv);

                    // å°†æ¶ˆæ¯æ·»åŠ åˆ°èŠå¤©å†å²
                    chatHistoryDiv.appendChild(msgDiv);
                });

                // æ»šåŠ¨åˆ°åº•éƒ¨
                chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
            })
            .catch(error => {
                console.error('è·å–èŠå¤©è®°å½•å¤±è´¥:', error);
                alert('æ— æ³•åŠ è½½èŠå¤©è®°å½•ï¼Œè¯·ç¨åé‡è¯•');
            });
    }


    function createNewChat() {
        axios.get('/api/chat/get_list')
            .then(response => {
                const chatLists = response.data;

                // æå–å·²æœ‰ conversationId çš„æ•°å­—
                const existingIds = new Set(chatLists.map(chat => parseInt(chat.conversationId)));

                // ç”Ÿæˆä¸é‡å¤çš„ conversationId
                let newId = 1;
                while (existingIds.has(newId)) {
                    newId++;
                }

                const newChatName = `ä¼šè¯${newId}`;

                // è°ƒç”¨åç«¯æ¥å£æ·»åŠ æ–°ä¼šè¯
                axios.post('/api/chat/add_list', {
                    conversationId: newId,
                    description: newChatName
                }, {
                    headers: {
                        'Content-Type': 'application/json'
                    }
                }).then(response => {
                    console.log("æ–°å»ºèŠå¤©å·²å‘é€åˆ°åç«¯");

                    // åˆ›å»ºå¹¶æ·»åŠ å‰ç«¯ä¼šè¯ DOM
                    const container = document.getElementById('chat_list_container');
                    const newChat = document.createElement('div');
                    newChat.className = 'new_chat new_chat_text';
                    newChat.dataset.convid = newChatName;
                    newChat.onclick = function() { switchChat(this); };

                    const title = document.createElement('div');
                    title.className = 'no-select';
                    title.style.flex = '8';
                    title.style.color = '#262626';
                    title.textContent = newChatName;

                    newChat.appendChild(title);
                    container.appendChild(newChat);
                }).catch(error => {
                    console.error("æ–°å»ºèŠå¤©å¤±è´¥:", error);
                    alert("åˆ›å»ºæ–°èŠå¤©å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•");
                });
            })
            .catch(error => {
                console.error('è·å–å·²æœ‰ä¼šè¯åˆ—è¡¨å¤±è´¥:', error);
                alert('æ— æ³•åˆ›å»ºæ–°ä¼šè¯ï¼Œè¯·ç¨åé‡è¯•');
            });
    }


    function btn_icon() {
        console.log("åˆ‡æ¢å›¾æ ‡");
    }
    document.getElementById('downloadDataBtn').addEventListener('click', downloadData);

    function downloadData() {
        axios({
            url: '/api/chat/download', // ä¿®æ”¹ä¸ºä½ çš„æ¥å£è·¯å¾„
            method: 'GET',
            responseType: 'blob' // é‡è¦ï¼šå‘Šè¯‰ axios è¿”å›çš„æ˜¯äºŒè¿›åˆ¶æ•°æ®
        })
            .then(response => {
                const blob = new Blob([response.data], { type: 'application/zip' }); // å¯æ ¹æ®æ–‡ä»¶ç±»å‹ä¿®æ”¹
                const link = document.createElement('a');
                link.href = window.URL.createObjectURL(blob);
                link.download = 'handler.zip'; // æŒ‡å®šä¸‹è½½çš„æ–‡ä»¶å
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(link.href); // é‡Šæ”¾ blob å¯¹è±¡
            })
            .catch(error => {
                console.error('ä¸‹è½½å¤±è´¥ï¼š', error);
                alert('ä¸‹è½½å¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
            });
    }
    document.getElementById('sendDataBtn').addEventListener('click', sendData);

    function sendData() {
        axios.post('/api/chat/send-to-python', null) // å¦‚æœä½ è¦ä¼ æ•°æ®ï¼Œå¯ä»¥æ”¾åœ¨ç¬¬äºŒä¸ªå‚æ•°ä¸­
            .then(response => {
                alert('å‘é€æˆåŠŸï¼');
                console.log('å‘é€æ•°æ®æˆåŠŸ:', response.data);
            })
            .catch(error => {
                console.error('å‘é€æ•°æ®å¤±è´¥:', error);
                alert('å‘é€å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            });
    }


</script>

</body>
</html>
